<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cl√≠nicaSys Pro v5.1</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
    <style>
        :root { --bg-main: #111827; --bg-card: #1F2937; --bg-input: #374151; --text: #F3F4F6; --muted: #9CA3AF; --primary: #10B981; --danger: #EF4444; --warning: #F59E0B; --info: #3B82F6; --border: #4B5563; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg-main); color: var(--text); height: 100vh; overflow: hidden; }
        
        #login-screen { display: flex; align-items: center; justify-content: center; height: 100vh; width: 100%; position: fixed; top: 0; left: 0; background: var(--bg-main); z-index: 99999; }
        .login-box { background: var(--bg-card); padding: 3rem; border-radius: 12px; border: 1px solid var(--border); width: 400px; text-align: center; }
        .login-box h2 { color: var(--primary); margin-bottom: 2rem; }
        .login-box input { width: 100%; padding: 12px; margin-bottom: 1rem; background: var(--bg-input); border: 1px solid var(--border); border-radius: 6px; color: white; }
        .login-box button { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        
        #app-screen { display: none; height: 100vh; width: 100%; position: relative; z-index: 1; display: flex; }
        
        /* RESPONSIVIDADE MENU */
        aside { width: 260px; background: var(--bg-card); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 1.5rem; transition: width 0.3s; }
        @media (max-width: 800px) { aside { width: 70px; padding: 1rem 0.5rem; } aside h2, aside small, aside button span { display: none; } aside button { justify-content: center; } }
        
        main { flex: 1; overflow-y: auto; padding: 2rem; min-width: 0; }
        
        .btn { padding: 8px 16px; border-radius: 6px; font-weight: 600; cursor: pointer; border: none; color: white; display: inline-flex; align-items: center; gap: 5px; transition: 0.2s; font-size: 0.9rem; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-p { background: var(--primary); } .btn-d { background: var(--danger); } .btn-s { background: var(--bg-input); } .btn-i { background: var(--info); }
        
        .card { background: var(--bg-card); padding: 1.5rem; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 1.5rem; overflow: auto; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        
        /* GRID DO DASHBOARD */
        .dash-content { display: grid; grid-template-columns: 3fr 1fr; gap: 1.5rem; }
        @media (max-width: 1000px) { .dash-content { grid-template-columns: 1fr; } }

        .espera-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem; }
        .espera-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; position: relative; border-left: 6px solid var(--muted); display: flex; flex-direction: column; gap: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.2); transition: transform 0.2s; }
        .espera-card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px rgba(0,0,0,0.3); }
        .ec-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .ec-time { font-size: 2rem; font-weight: 700; color: var(--text); letter-spacing: -1px; line-height: 1; }
        .ec-status-badge { font-size: 0.7rem; padding: 3px 8px; border-radius: 4px; background: var(--bg-input); color: white; font-weight: 600; text-transform: uppercase; }
        .ec-body h3 { font-size: 1.2rem; color: white; margin-bottom: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 600; }
        .ec-prof { font-size: 0.9rem; color: var(--muted); display: flex; align-items: center; gap: 6px; margin-bottom: 4px; }
        .ec-room { font-size: 0.85rem; color: var(--primary); font-weight: 600; }
        .border-agendado { border-left-color: var(--muted); } .border-confirmado { border-left-color: var(--info); } .border-espera { border-left-color: var(--warning); } .border-atendimento { border-left-color: var(--info); } .border-finalizado { border-left-color: var(--primary); } .border-cancelado { border-left-color: var(--danger); opacity: 0.6; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th { padding: 12px; background: var(--bg-input); color: var(--muted); text-align: left; font-size: 0.85rem; }
        td { padding: 12px; border-bottom: 1px solid var(--border); font-size: 0.9rem; }
        input, select, textarea { background: var(--bg-input); border: 1px solid var(--border); padding: 10px; border-radius: 6px; color: white; width: 100%; outline: none; margin-bottom: 10px; }
        label { display: block; color: var(--muted); font-size: 0.8rem; margin-bottom: 4px; }
        
        nav button { width: 100%; padding: 12px; background: transparent; border: none; color: var(--muted); text-align: left; cursor: pointer; border-radius: 8px; margin-bottom: 5px; font-weight: 500; display: flex; gap: 10px; }
        nav button:hover, nav button.active { background: var(--primary); color: white; }
        
        .tabs { display: flex; border-bottom: 1px solid var(--border); margin-bottom: 1.5rem; }
        .tab { padding: 10px 20px; cursor: pointer; color: var(--muted); border-bottom: 2px solid transparent; }
        .tab.active { color: var(--primary); border-color: var(--primary); }
        .tab-content { display: none; } .tab-content.active { display: block; }
        
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: flex-start; z-index: 100; overflow-y: auto; padding: 2rem; backdrop-filter: blur(3px); }
        .modal { background: var(--bg-card); width: 100%; max-width: 700px; padding: 2rem; border-radius: 12px; border: 1px solid var(--border); position: relative; }
        .modal-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .row { display: flex; gap: 10px; } .col { flex: 1; }
        
        #toast { visibility: hidden; min-width: 250px; background-color: #10B981; color: #fff; text-align: center; border-radius: 4px; padding: 16px; position: fixed; z-index: 2000; left: 50%; bottom: 30px; transform: translateX(-50%); box-shadow: 0 4px 6px rgba(0,0,0,0.3); font-weight: bold; }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} } @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
        
        .wa-icon { width: 24px; height: 24px; fill: #25D366; vertical-align: middle; cursor: pointer; transition: transform 0.2s; }
        .wa-icon:hover { transform: scale(1.2); }
        
        .rel-summary { display: flex; gap: 10px; margin-bottom: 20px; }
        .rel-card { flex: 1; background: var(--bg-input); padding: 15px; border-radius: 8px; text-align: center; }
        .rel-card h3 { font-size: 0.9rem; color: var(--muted); }
        .rel-card h1 { font-size: 1.5rem; color: white; }

        #print-receita { display: none; }
        @media print {
            body * { visibility: hidden; }
            #print-receita, #print-receita * { visibility: visible; display: block; }
            #print-receita { position: absolute; top: 0; left: 0; width: 100%; background: white; color: black; padding: 2rem; font-size: 12pt; }
            #v-relatorios { display: block !important; position: absolute; top: 0; left: 0; width: 100%; height: auto; background: white; color: black; padding: 20px; z-index: 9999; }
            #v-relatorios * { visibility: visible; color: black !important; background: transparent !important; box-shadow: none !important; border-color: #ccc !important; }
            #rel-tab { border: 1px solid #000; width: 100%; border-collapse: collapse; }
            #rel-tab th, #rel-tab td { border: 1px solid #000; padding: 8px; text-align: left; font-size: 10pt; }
            .no-print, button, input, select, label, .fc-header-toolbar { display: none !important; }
            .rel-summary { display: flex !important; }
            body { background: white !important; height: auto; overflow: visible; }
        }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-box">
        <h2>üè• Cl√≠nicaSys</h2>
        <form onsubmit="event.preventDefault(); doLogin();">
            <input type="text" id="login-user" placeholder="Usu√°rio (admin)" required>
            <input type="password" id="login-pass" placeholder="Senha (admin123)" required>
            <button type="submit" id="btn-entrar">Entrar</button>
        </form>
    </div>
</div>

<div id="app-screen" style="display:none">
    <aside class="no-print">
        <div style="margin-bottom:2rem; padding-left:10px;">
            <h2 style="color:var(--primary);">üè• Cl√≠nicaSys</h2>
            <small style="color:var(--muted); font-size:0.75rem; display:block; margin-top:5px;">Licenciado para:<br><strong id="header-title" style="color:white;">Minha Cl√≠nica</strong></small>
        </div>
        <nav>
            <button class="active" onclick="nav('dashboard', this)">üìä <span>Dashboard</span></button>
            <button onclick="nav('espera', this)">‚è≥ <span>Sala de Espera</span></button>
            <button onclick="nav('pacientes', this)">üë• <span>Pacientes</span></button>
            <button onclick="nav('profissionais', this)">üë®‚Äç‚öïÔ∏è <span>Profissionais</span></button>
            <button onclick="nav('agenda', this)">üìÖ <span>Agenda</span></button>
            <button onclick="nav('atendimento', this)">ü©∫ <span>Atendimento</span></button>
            <button onclick="nav('financeiro', this)">üí∞ <span>Financeiro</span></button>
            <button onclick="nav('relatorios', this)">üìà <span>Relat√≥rios</span></button>
            <button onclick="nav('cadastros', this)">‚öôÔ∏è <span>Cadastros</span></button>
        </nav>
        <div style="margin-top:auto; padding-top:1rem; border-top:1px solid var(--border)">
            <button class="btn btn-s" style="width:100%; margin-bottom:5px; background:#374151; border:1px solid #4B5563" onclick="mostrarIpServidor()">üì° <span>Acesso Externo</span></button>
            <button class="btn btn-s" style="width:100%; margin-bottom:5px" onclick="abrirModalConta()">üë§ <span>Minha Conta</span></button>
            <button class="btn btn-s" style="width:100%; margin-bottom:5px" onclick="window.open(API+'/backup')">üíæ <span>Backup</span></button>
            <button class="btn btn-d" style="width:100%" onclick="doLogout()"><span>Sair</span></button>
        </div>
    </aside>

    <main id="app">
        <div id="v-dashboard" class="view">
            <div class="grid">
                <div class="card"><h3>Hoje</h3><h1 id="d-hoje">0</h1></div>
                <div class="card"><h3>M√™s</h3><h1 id="d-mes">0</h1></div>
                <div class="card"><h3>Faturamento</h3><h1 style="color:var(--primary)" id="d-fat">R$ 0</h1></div>
                <div class="card"><h3>Pend√™ncias</h3><h1 style="color:var(--danger)" id="d-pend">0</h1></div>
            </div>
            <div class="dash-content">
                <div class="card" style="min-height:500px"><div id="calendar"></div></div>
                <div class="card"><h3>Pr√≥ximos</h3><div id="prox-lista" style="margin-top:15px"></div></div>
            </div>
            <div class="card" style="margin-top: 1.5rem; height: 300px;"><canvas id="chart"></canvas></div>
        </div>
        
        <div id="v-espera" class="view" style="display:none"><div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;"><h2>Sala de Espera (Hoje)</h2><button class="btn btn-p" onclick="loadEspera()">üîÑ Atualizar</button></div><div id="espera-lista" class="espera-grid"></div></div>
        <div id="v-pacientes" class="view" style="display:none"><div class="card"><div style="display:flex; justify-content:space-between"><input type="text" placeholder="Buscar..." style="width:300px" onkeyup="loadPac(this.value)"><button class="btn btn-p" onclick="modPac()">+ Novo</button></div><table><thead><tr><th>Nome</th><th>CPF</th><th>Tel</th><th>A√ß√£o</th></tr></thead><tbody id="t-pac"></tbody></table></div></div>
        <div id="v-profissionais" class="view" style="display:none"><div class="card"><div style="display:flex; justify-content:space-between"><h2>Profissionais</h2><button class="btn btn-p" onclick="modProf()">+ Novo</button></div><table><thead><tr><th>Nome</th><th>CRM</th><th>Espec.</th><th>A√ß√£o</th></tr></thead><tbody id="t-prof"></tbody></table></div></div>
        <div id="v-agenda" class="view" style="display:none"><div class="card"><div style="display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap; margin-bottom:15px"><div><label>De:</label><input type="date" id="ag-ini" style="width:auto" onchange="loadAgenda()"></div><div><label>At√©:</label><input type="date" id="ag-fim" style="width:auto" onchange="loadAgenda()"></div><div><label>Profissional:</label><select id="ag-filter-prof" style="width:auto" onchange="loadAgenda()"><option value="">Todos</option></select></div><button class="btn btn-p" style="margin-left:auto; margin-bottom:10px" onclick="modAg()">+ Agendar</button></div><table><thead><tr><th>Data / Hora</th><th>Paciente</th><th>Profissional</th><th>Status</th><th width="100">A√ß√£o</th></tr></thead><tbody id="t-ag"></tbody></table></div></div>
        <div id="v-atendimento" class="view" style="display:none"><div class="card" id="atend-sel-area"><h2>Iniciar Atendimento</h2><div style="display:flex; gap:10px"><select id="atend-pac-sel"></select><button class="btn btn-p" onclick="startAtend()">Abrir Prontu√°rio</button></div></div><div id="atend-main" style="display:none"><button class="btn btn-s" onclick="closeAtend()" style="margin-bottom:1rem">Voltar</button><h2 id="atend-pac-name" style="color:var(--primary)"></h2><div class="card"><div class="row"><div class="col"><label>Evolu√ß√£o Cl√≠nica</label><textarea id="at-evo" rows="5"></textarea></div></div><div class="row"><div class="col"><label>Prescri√ß√£o</label><textarea id="at-pres" rows="3"></textarea></div><div class="col"><label>Exames Solicitados</label><textarea id="at-exm" rows="3"></textarea></div></div><div style="margin-bottom:10px"><label>Diagn√≥stico (CID)</label><input id="atend-cid"></div><div style="text-align:right; border-top:1px solid var(--border); padding-top:10px;"><label style="display:inline-block; margin-right:10px;">Profissional:</label><select id="at-prof" style="width:auto; display:inline-block"></select><button class="btn btn-s" onclick="imprimirReceita()" style="margin-right:10px">üñ®Ô∏è Imprimir Receita</button><button class="btn btn-p" onclick="saveAtend()">Salvar Atendimento</button></div></div><div class="card"><h3>Hist√≥rico</h3><table><thead><tr><th>Data</th><th>Profissional</th><th>Resumo</th></tr></thead><tbody id="at-hist"></tbody></table></div></div></div>
        <div id="v-financeiro" class="view" style="display:none"><div class="tabs"><div class="tab active" onclick="tabFin('receber', this)">A Receber</div><div class="tab" onclick="tabFin('pagar', this)">A Pagar</div><div class="tab" onclick="tabFin('caixa', this)">Caixa</div></div><div class="card"><div style="margin-bottom:1rem"><button class="btn btn-p" onclick="modFin()">+ Lan√ßamento</button></div><table><tbody id="t-fin"></tbody></table></div></div>
        <div id="v-relatorios" class="view" style="display:none"><div class="card"><h2 class="no-print">Relat√≥rios Gerenciais</h2><div class="no-print" style="display:flex; gap:15px; margin-bottom:20px; align-items:flex-end;"><div><label>Tipo</label><select id="rel-tipo"><option value="agendamentos">Agendamentos</option><option value="financeiro">Financeiro</option><option value="profissionais">Produtividade</option><option value="pacientes">Pacientes</option><option value="convenios">Conv√™nios (Ranking)</option><option value="aniversariantes">Aniversariantes (M√™s)</option></select></div><div><label>In√≠cio</label><input type="date" id="rel-ini"></div><div><label>Fim</label><input type="date" id="rel-fim"></div><button class="btn btn-p" onclick="gerarRel()">Gerar Relat√≥rio</button><button class="btn btn-s" onclick="window.print()">üñ®Ô∏è Imprimir</button></div><div id="rel-header-print" style="display:none; margin-bottom:20px; border-bottom:2px solid black;"><h2>Relat√≥rio Gerencial</h2><p id="rel-periodo-print"></p></div><div id="rel-summary-area"></div> <div id="printable-area"><table id="rel-tab"><thead></thead><tbody></tbody></table></div></div></div>
        <div id="v-cadastros" class="view" style="display:none"><div class="card"><div class="tabs"><div class="tab active" onclick="loadAux('especialidades', this)">Especialidades</div><div class="tab" onclick="loadAux('convenios', this)">Conv√™nios</div><div class="tab" onclick="loadAux('salas', this)">Salas</div><div class="tab" onclick="loadAux('procedimentos', this)">Procedimentos</div></div><div id="aux-simple-ctrl" style="display:flex; gap:10px"><input type="text" id="aux-nome" placeholder="Novo item..."><button class="btn btn-p" onclick="salvAux()">Adicionar</button></div><div id="aux-conv-ctrl" style="display:none; margin-bottom:10px"><button class="btn btn-p" onclick="modConv()">+ Novo Conv√™nio</button></div><table><tbody id="t-aux"></tbody></table></div></div>
    </main>
</div>

<div id="m-conta" class="overlay"><div class="modal"><div class="modal-head"><h2>Minha Conta</h2><button class="btn btn-d" onclick="closeM('m-conta')">X</button></div><div class="tabs" style="margin-top:10px"><div class="tab active" onclick="subTab(this,'c-dados')">Dados da Cl√≠nica</div><div class="tab" onclick="subTab(this,'c-senha')">Seguran√ßa</div></div><div id="c-dados" class="tab-content active"><label>Nome</label><input id="conf-nome"><label>Endere√ßo</label><input id="conf-end"><div class="row"><div class="col"><label>Telefone</label><input id="conf-tel" class="mask-tel"></div></div><button class="btn btn-p" onclick="salvarConfig()" style="width:100%">Salvar</button></div><div id="c-senha" class="tab-content"><label>Senha Antiga</label><input type="password" id="senha-antiga"><label>Nova</label><input type="password" id="senha-nova"><label>Confirmar</label><input type="password" id="senha-confirma"><button class="btn btn-d" onclick="salvarNovaSenha()" style="width:100%">Alterar</button></div></div></div>
<div id="m-fin" class="overlay"><div class="modal"><div class="modal-head"><h2>Financeiro</h2><button class="btn btn-d" onclick="closeM('m-fin')">X</button></div><label>Tipo</label><select id="f-tipo" onchange="toggleFin()"><option value="receber">Receita</option><option value="pagar">Despesa</option></select><div id="d-pac"><label>Paciente</label><select id="f-pac"></select></div><div id="d-forn" style="display:none"><label>Fornecedor</label><input id="f-forn"></div><div class="row"><div class="col"><label>Desc</label><input id="f-desc"></div><div class="col"><label>Valor</label><input type="number" id="f-val" step="0.01"></div></div><div class="row"><div class="col"><label>Venc</label><input type="date" id="f-venc" style="color-scheme:dark"></div><div class="col"><label>Parc</label><input type="number" id="f-parc" value="1"></div></div><div class="row"><div class="col"><label>Categoria <span style="color:red">*</span></label><input id="f-cat"></div><div class="col"><label>Centro Custo</label><input id="f-cc"></div><div class="col"><label>Forma</label><select id="f-forma"><option>Dinheiro</option><option>Pix</option><option>Cart√£o</option></select></div></div><button class="btn btn-p" style="width:100%" onclick="saveFin()">Salvar Lan√ßamento</button></div></div>
<div id="m-transf" class="overlay"><div class="modal"><div class="modal-head"><h2>Reagendar</h2><button class="btn btn-d" onclick="closeM('m-transf')">X</button></div><input type="hidden" id="tr-id"><input type="hidden" id="tr-pac-nome"><input type="hidden" id="tr-pac-tel"><label>Profissional</label><select id="tr-prof"></select><div class="row"><div class="col"><label>Data</label><input type="date" id="tr-data" style="color-scheme:dark"></div><div class="col"><label>Hora</label><input type="time" id="tr-hora" style="color-scheme:dark"></div></div><div style="text-align:right;margin-top:10px"><button class="btn btn-p" onclick="confTransf()">Confirmar</button></div></div></div>
<div id="m-fim" class="overlay"><div class="modal"><div class="modal-head"><h2>Finalizar</h2><button class="btn btn-d" onclick="closeM('m-fim')">X</button></div><input type="hidden" id="fim-id"><label><input type="checkbox" id="fim-retorno" onchange="toggleRetorno()"> Agendar Retorno</label><div id="fim-area-retorno" style="display:none; margin-top:10px;"><div class="row"><div class="col"><input type="date" id="fim-data" style="color-scheme:dark"></div><div class="col"><input type="time" id="fim-hora" style="color-scheme:dark"></div></div></div><button class="btn btn-p" onclick="confFim()" style="float:right; margin-top:10px">Concluir</button></div></div>
<div id="m-pac" class="overlay"><div class="modal"><div class="modal-head"><h2>Paciente</h2><button class="btn btn-d" onclick="closeM('m-pac')">X</button></div><input type="hidden" id="p-id"><div class="row"><div class="col"><label>Nome</label><input id="p-nome"></div><div class="col"><label>CPF</label><input id="p-cpf" class="mask-cpf"></div></div><div class="row"><div class="col"><label>RG</label><input id="p-rg"></div><div class="col"><label>Nasc</label><input type="date" id="p-nasc" style="color-scheme:dark"></div><div class="col"><label>Sexo</label><select id="p-sexo"><option>M</option><option>F</option></select></div></div><div class="row"><div class="col"><label>Tel</label><input id="p-tel1" class="mask-tel"></div><div class="col"><label>Email</label><input id="p-email"></div></div><label>End</label><input id="p-end"><label>Conv</label><select id="p-conv"></select><label>Meds</label><input id="p-meds"><label>Obs</label><textarea id="p-obs" rows="3"></textarea><button class="btn btn-p" style="width:100%" onclick="savePac()">Salvar</button></div></div>
<div id="m-prof" class="overlay"><div class="modal"><div class="modal-head"><h2>Profissional</h2><button class="btn btn-d" onclick="closeM('m-prof')">X</button></div><input type="hidden" id="pr-id"><div class="tabs" style="margin-top:1rem"><div class="tab active" onclick="subTab(this,'pr-dados')">Dados</div><div class="tab" onclick="subTab(this,'pr-end')">End</div><div class="tab" onclick="subTab(this,'pr-fin')">Fin</div></div><div id="pr-dados" class="tab-content active"><div class="row"><div class="col"><label>Nome</label><input id="pr-nome"></div><div class="col"><label>CRM</label><input id="pr-crm"></div></div><div class="row"><div class="col"><label>CPF</label><input id="pr-cpf" class="mask-cpf"></div><div class="col"><label>Nasc</label><input type="date" id="pr-nasc" style="color-scheme:dark"></div></div><div class="row"><div class="col"><label>Email</label><input id="pr-email"></div><div class="col"><label>Tel</label><input id="pr-tel" class="mask-tel"></div></div><label>Espec</label><select id="pr-esp"></select><label>Dias</label><input id="pr-dias"></div><div id="pr-end" class="tab-content"><label>Endere√ßo</label><input id="pr-rua"><div class="row"><div class="col"><label>Bairro</label><input id="pr-bairro"></div><div class="col"><label>Cidade</label><input id="pr-cid"></div></div></div><div id="pr-fin" class="tab-content"><div class="row"><div class="col"><label>Banco</label><input id="pr-banco"></div><div class="col"><label>Ag</label><input id="pr-ag"></div><div class="col"><label>CC</label><input id="pr-cc"></div></div><div class="row"><div class="col"><label>Pix</label><input id="pr-pix"></div><div class="col"><label>Com%</label><input type="number" id="pr-comissao"></div></div></div><button class="btn btn-p" style="width:100%; margin-top:1rem" onclick="saveProf()">Salvar</button></div></div>
<div id="m-conv" class="overlay"><div class="modal"><div class="modal-head"><h2>Conv√™nio</h2><button class="btn btn-d" onclick="closeM('m-conv')">X</button></div><input type="hidden" id="cv-id"><div class="row"><div class="col"><label>Nome</label><input id="cv-nome"></div><div class="col"><label>ANS</label><input id="cv-ans"></div></div><div class="row"><div class="col"><label>CNPJ</label><input id="cv-cnpj"></div><div class="col"><label>Prazo</label><input type="number" id="cv-prazo"></div></div><div class="row"><div class="col"><label>Email</label><input id="cv-email"></div><div class="col"><label>Site</label><input id="cv-site"></div></div><button class="btn btn-p" style="width:100%" onclick="saveConv()">Salvar</button></div></div>
<div id="m-ag" class="overlay"><div class="modal"><div class="modal-head"><h2>Agendar</h2><button class="btn btn-d" onclick="closeM('m-ag')">X</button></div><label>Paciente</label><select id="a-pac"></select><label>Profissional</label><select id="a-prof"></select><div class="row"><div class="col"><label>Data</label><input type="date" id="a-data" style="color-scheme:dark"></div><div class="col"><label>Hora</label><input type="time" id="a-hora" style="color-scheme:dark"></div><div class="col"><label>Dur</label><input type="number" id="a-dur" value="30"></div></div><label>Sala</label><select id="a-sala"></select><button class="btn btn-p" style="width:100%" onclick="saveAg()">Agendar</button></div></div>
<div id="m-baixa" class="overlay"><div class="modal" style="width:400px"><div class="modal-head"><h2>Baixar</h2><button class="btn btn-d" onclick="closeM('m-baixa')">X</button></div><input type="hidden" id="b-id"><label>Valor Pago</label><input type="number" id="b-val" step="0.01"><button class="btn btn-p" style="width:100%; margin-top:10px;" onclick="confBaixa()">Confirmar</button></div></div>
<div id="m-dia" class="overlay"><div class="modal"><div class="modal-head"><h2 id="dia-titulo"></h2><button class="btn btn-d" onclick="closeM('m-dia')">X</button></div><div id="dia-lista"></div><div style="margin-top:20px; text-align:right;"><button class="btn btn-p" onclick="modAgDia()">+ Novo</button></div></div></div>
<div id="m-leitura" class="overlay" style="z-index: 3000;"><div class="modal"><div class="modal-head"><h3>Hist√≥rico</h3><button class="btn btn-d" onclick="closeM('m-leitura')">X</button></div><div id="conteudo-leitura" style="white-space: pre-wrap; line-height: 1.6; background:var(--bg-input); padding:15px; border-radius:8px; max-height:60vh; overflow-y:auto;"></div></div></div>

<div id="toast">Notifica√ß√£o</div>
<div id="print-receita"></div>

<script>
const API='/api'; 
let curFin='receber',curAux='especialidades',calendar=null,curChart=null,refreshTimer=null,currentAgId=null,clinicConfig={};
const ICON_WA='<svg class="wa-icon" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.008-.57-.008-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg>';
const el=id=>document.getElementById(id),val=id=>el(id)?el(id).value:'';
const req=async(u,m='GET',d=null,s=false)=>{try{const o={method:m,headers:{'Content-Type':'application/json'},credentials:'include'};if(d)o.body=JSON.stringify(d);const r=await fetch(API+u,o);if(r.status===401&&!s){return null;}return await r.json();}catch(e){if(!s)showToast("Erro:"+e,'erro');return null;}};
function showToast(m,t='s'){const x=el("toast");x.innerText=m;x.style.backgroundColor=t==='erro'?'#EF4444':'#10B981';x.className="show";setTimeout(()=>x.className="",3000);}
function mascaraCPF(i){let v=i.value.replace(/\D/g,"");v=v.replace(/(\d{3})(\d)/,"$1.$2");v=v.replace(/(\d{3})(\d)/,"$1.$2");v=v.replace(/(\d{3})(\d{1,2})$/,"$1-$2");i.value=v;}
function mascaraTel(i){let v=i.value.replace(/\D/g,"");v=v.replace(/^(\d{2})(\d)/,"($1) $2");v=v.replace(/(\d)(\d{4})$/,"$1-$2");i.value=v;}
document.addEventListener('input',e=>{if(e.target.classList.contains('mask-cpf'))mascaraCPF(e.target);if(e.target.classList.contains('mask-tel'))mascaraTel(e.target);});

function imprimirReceita(){const p=el('atend-pac-name').innerText.replace('Paciente: ',''),pr=val('at-pres'),ex=val('at-exm'),dt=new Date().toLocaleDateString();const h=`<div style="text-align:center;margin-bottom:3rem;border-bottom:2px solid #000;padding-bottom:1rem"><h2>${(clinicConfig.nome_clinica||'Cl√≠nica').toUpperCase()}</h2><p>${clinicConfig.endereco||''} - ${clinicConfig.telefone||''}</p></div><div style="margin-bottom:2rem"><strong>Paciente:</strong> ${p}<br><strong>Data:</strong> ${dt}</div>${pr?`<div style="margin-bottom:2rem"><h3>üíä Prescri√ß√£o</h3><pre style="font-family:inherit;white-space:pre-wrap">${pr}</pre></div>`:''}${ex?`<div style="margin-bottom:2rem"><h3>üî¨ Exames</h3><pre style="font-family:inherit;white-space:pre-wrap">${ex}</pre></div>`:''}<div style="margin-top:4rem;text-align:center;border-top:1px solid #000;width:50%;margin:auto;padding-top:10px">Assinatura</div>`;el('print-receita').innerHTML=h;window.print();}

const fill=async(id,u)=>{const l=await req(u);if(el(id))el(id).innerHTML=(l||[]).map(i=>`<option value="${i.id}"${i.telefone_principal?` data-tel="${i.telefone_principal}"`:''}>${i.nome}</option>`).join('');};

// --- FUN√á√ïES DE LOGIN E INICIALIZA√á√ÉO ---
async function checkAuth(){
    const u = await req('/check_auth','GET',null,true);
    if(u && u.user){
        el('login-screen').style.display='none';
        el('app-screen').style.display='flex';
        await loadConfig();
        nav('dashboard',document.querySelector('nav button'));
    } else {
        el('login-screen').style.display='flex';
        el('app-screen').style.display='none';
    }
}

async function doLogin(){
    const btn = el('btn-entrar');
    btn.innerText = 'Entrando...'; btn.disabled=true;
    const res = await req('/login','POST',{username:val('login-user'),password:val('login-pass')}, true);
    if(res && res.msg === "Logado"){
        checkAuth(); 
    } else {
        alert("Erro: " + (res && res.erro ? res.erro : "Usu√°rio ou senha incorretos"));
        btn.innerText = 'Entrar'; btn.disabled=false;
    }
}

async function doLogout(){
    await req('/logout','POST');
    location.reload();
}

async function loadConfig(){clinicConfig=await req('/config');if(clinicConfig.nome_clinica)el('header-title').innerText=clinicConfig.nome_clinica;}
function mostrarIpServidor(){alert(`Para acessar de outro computador, digite:\n${clinicConfig.ip_rede||'Verifique no servidor'}`);}

function abrirModalConta(){el('m-conta').style.display='flex';if(clinicConfig){el('conf-nome').value=clinicConfig.nome_clinica||'';el('conf-end').value=clinicConfig.endereco||'';el('conf-tel').value=clinicConfig.telefone||'';}}
async function salvarConfig(){if(await req('/config/salvar','POST',{nome:val('conf-nome'),end:val('conf-end'),tel:val('conf-tel')})){showToast("Salvo!");loadConfig();closeM('m-conta');}}
async function salvarNovaSenha(){if(val('senha-nova')!=val('senha-confirma'))return showToast("Senhas diferem",'erro');if(await req('/mudar_senha','POST',{antiga:val('senha-antiga'),nova:val('senha-nova')})){showToast("Senha alterada!");closeM('m-conta');}}

function nav(v,btn){document.querySelectorAll('.view').forEach(x=>x.style.display='none');if(el('v-'+v))el('v-'+v).style.display='block';document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));if(btn)btn.classList.add('active');if(refreshTimer){clearInterval(refreshTimer);refreshTimer=null;}
if(v=='dashboard'){loadDash();setTimeout(initCalendar,100);}
if(v=='espera'){loadEspera();refreshTimer=setInterval(loadEspera,30000);}
if(v=='pacientes')loadPac('');if(v=='profissionais')loadProf();if(v=='cadastros')loadAux('especialidades',document.querySelector('#v-cadastros .tab'));
if(v=='agenda'){const h=new Date().toISOString().split('T')[0];if(!val('ag-ini'))el('ag-ini').value=h;if(!val('ag-fim'))el('ag-fim').value=h;fill('ag-filter-prof','/profissionais');loadAgenda();}
if(v=='atendimento')fill('atend-pac-sel','/pacientes');if(v=='financeiro')tabFin('receber',document.querySelector('#v-financeiro .tab'));if(v=='relatorios'){el('rel-ini').valueAsDate=new Date();el('rel-fim').valueAsDate=new Date();}}

function closeM(id){el(id).style.display='none';}
function subTab(btn,cid){const m=btn.closest('.modal')||btn.closest('.card');m.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));btn.classList.add('active');m.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));el(cid).classList.add('active');}

async function loadDash(){const d=await req('/dashboard_stats');if(d){el('d-hoje').innerText=d.hoje;el('d-mes').innerText=d.mes;el('d-fat').innerText='R$ '+d.faturamento;el('d-pend').innerText=d.pendencias;
    // PROXIMOS AGENDAMENTOS CORRIGIDO
    const lista = el('prox-lista');
    if(d.proximos && d.proximos.length > 0){
        lista.innerHTML=d.proximos.map(p=>`<div class="prox-item" style="margin-bottom:10px;background:var(--bg-input);padding:10px;border-radius:6px;"><div class="prox-time" style="font-weight:bold;color:var(--primary)">${p.data_hora_inicio.substring(11,16)}<span style="font-size:0.8rem;color:white"> ${p.data_hora_inicio.substring(8,10)}/${p.data_hora_inicio.substring(5,7)}</span></div><div class="prox-info"><h4>${p.paciente}</h4><p style="font-size:0.8rem;color:var(--muted)">üë®‚Äç‚öïÔ∏è ${p.profissional}</p></div></div>`).join('');
    } else {
        lista.innerHTML = '<p style="color:var(--muted); font-size:0.9rem;">Nenhuma consulta pr√≥xima.</p>';
    }
    const ctx=el('chart');if(curChart){curChart.destroy();curChart=null;}if(ctx&&d.grafico)curChart=new Chart(ctx,{type:'bar',data:{labels:d.grafico.map(i=>i.nome),datasets:[{label:'Consultas',data:d.grafico.map(i=>i.total),backgroundColor:'#10B981'}]}});}}

function initCalendar(){
    if(calendar)return;
    calendar=new FullCalendar.Calendar(el('calendar'),{
        initialView:'dayGridMonth',
        locale:'pt-br',
        height: 'auto', // Altura autom√°tica para n√£o gerar scroll duplo
        headerToolbar:{left:'prev,next',center:'title',right:'dayGridMonth,timeGridDay'},
        events:async(i,s)=>{const l=await req('/agenda/calendario');s((l||[]).map(e=>({title:e.title,start:e.start,backgroundColor:e.backgroundColor})));},
        dateClick:i=>verDia(i.dateStr)
    });
    calendar.render();
}
async function verDia(d){const l=await req('/agenda?inicio='+d+'&fim='+d);el('dia-titulo').innerText='Agenda: '+d.split('-').reverse().join('/');el('dia-titulo').dataset.date=d;const c=el('dia-lista');c.innerHTML=l.length?l.map(a=>`<div class="espera-item"><div><strong style="color:var(--primary)">${a.data_hora_inicio.substring(11,16)}</strong> - ${a.paciente}<div style="font-size:0.85rem;color:var(--muted)">Prof: ${a.profissional} | ${a.status}</div></div></div>`).join(''):'<p style="color:var(--muted);text-align:center">Vazio</p>';el('m-dia').style.display='flex';}
function modAgDia(){const d=el('dia-titulo').dataset.date;closeM('m-dia');modAg();el('a-data').value=d;}

async function loadEspera(){const l=await req('/sala_espera');const li=el('espera-lista');if(!l||!l.length){li.innerHTML='<div style="padding:40px;text-align:center;color:var(--muted)">Vazio</div>';return;}
li.innerHTML=l.map(a=>{const h=a.data_hora_inicio.length>=16?a.data_hora_inicio.substring(11,16):'--:--',d=a.data_hora_inicio.substring(8,10)+'/'+a.data_hora_inicio.substring(5,7),st=a.status||'Agendado';let b='border-agendado';if(st=='Cancelado')b='border-cancelado';else if(st=='Finalizado')b='border-finalizado';else if(st=='Em Atendimento')b='border-atendimento';else if(st=='Em Espera')b='border-espera';else if(st=='Confirmado')b='border-confirmado';
const w=a.paciente_tel?`<a href="https://api.whatsapp.com/send?phone=55${a.paciente_tel.replace(/\D/g,'')}" target="_blank" style="margin-left:5px">${ICON_WA}</a>`:'';
return `<div class="espera-card ${b}"><div class="ec-header"><span class="ec-time">${h}</span><span class="ec-status-badge">${st}</span></div><div class="ec-date">${d}</div><div class="ec-body"><h3>${a.paciente_nome}</h3><div class="ec-prof">üìû ${a.paciente_tel||'--'} ${w}</div><div class="ec-prof">üë®‚Äç‚öïÔ∏è ${a.profissional_nome||'-'}</div><div class="ec-room">üö™ ${a.sala_nome||'-'}</div></div><div class="ec-actions"><select onchange="processarAcao(this,${a.id},${a.paciente_id},${a.profissional_id},'${a.data_hora_inicio}','${a.paciente_nome}','${a.paciente_tel||''}')" style="width:100%;background:var(--bg-card);color:white;border:1px solid var(--border);padding:5px;border-radius:4px"><optgroup label="Atual: ${st}"><option value="" hidden>${st}</option></optgroup><optgroup label="A√ß√µes"><option value="Confirmado">‚úÖ Confirmar</option><option value="Em Espera">üèÉ Chegou</option><option value="Em Atendimento">ü©∫ Atender</option><option value="Finalizado">üèÅ Finalizar</option><option value="TRANSFERIR">üîÑ Transferir</option><option value="Cancelado">‚ùå Cancelar</option></optgroup></select></div></div>`;}).join('');}

async function processarAcao(s,aid,pid,prid,dh,pn,pt){const ac=s.value;if(ac=='TRANSFERIR'){openTransf(aid,prid,dh,pn,pt);s.value="";return;}if(ac=='Em Atendimento'){irParaAtendimento(aid,pid);return;}if(ac=='Finalizado'){openFim(aid);s.value="";return;}if(ac=='Cancelado'&&!confirm("Cancelar?")){s.value="";loadEspera();return;}await mudarSt(aid,ac);}
async function mudarSt(id,st){await req('/agenda/status','POST',{id,status:st});loadEspera();if(calendar)calendar.refetchEvents();loadDash();}
async function irParaAtendimento(aid,pid){await req('/agenda/status','POST',{id:aid,status:'Em Atendimento'});nav('atendimento');setTimeout(()=>{el('atend-pac-sel').value=pid;startAtend();},300);}

async function startAtend(){const pid=val('atend-pac-sel'),pr=val('at-prof');if(!pid)return showToast("Selecione Paciente",'erro');await req('/agenda/iniciar_atendimento_paciente','POST',{id:pid,prof_id:pr},true);const h=await req('/prontuario/'+pid),pn=el('atend-pac-sel').options[el('atend-pac-sel').selectedIndex].text;el('atend-pac-name').innerText="Paciente: "+pn;el('atend-sel-area').style.display='none';el('atend-main').style.display='block';fill('at-prof','/profissionais');el('at-hist').innerHTML=(h||[]).map(i=>`<tr><td>${i.data_atendimento}</td><td>${i.profissional}</td><td><div style="max-width:200px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:inline-block;vertical-align:middle;">${i.evolucao_clinica}</div><button class="btn btn-s" style="float:right;font-size:0.7rem" onclick='verDetalheHist(${JSON.stringify(i.evolucao_clinica)})'>Ler</button></td></tr>`).join('');}
function verDetalheHist(t){el('conteudo-leitura').innerText=t;el('m-leitura').style.display='flex';}
function closeAtend(){el('atend-main').style.display='none';el('atend-sel-area').style.display='block';loadEspera();}
async function saveAtend(){if(await req('/prontuario/salvar','POST',{paciente_id:val('atend-pac-sel'),profissional_id:val('at-prof'),evolucao:val('at-evo'),prescricao:val('at-pres'),exames:val('at-exm')})){showToast('Salvo!');closeAtend();}}

function openTransf(id,prid,dh,pn,pt){el('m-transf').style.display='flex';el('tr-id').value=id;el('tr-pac-nome').value=pn;el('tr-pac-tel').value=pt;fill('tr-prof','/profissionais').then(()=>{el('tr-prof').value=prid;});const p=dh.split(' ');el('tr-data').value=p[0];el('tr-hora').value=p[1].substring(0,5);}
async function confTransf(){const d=val('tr-data'),h=val('tr-hora');if(await req('/agendamento/transferir','POST',{id:val('tr-id'),profissional_id:val('tr-prof'),data:d,hora:h})){showToast('Transferido!');closeM('m-transf');loadEspera();if(calendar)calendar.refetchEvents();if(val('tr-pac-tel')){const msg=`Ol√° *${val('tr-pac-nome')}*, reagendado para *${d.split('-').reverse().join('/')}* √†s *${h}* com *${el('tr-prof').options[el('tr-prof').selectedIndex].text}*.`;window.open(`https://api.whatsapp.com/send?phone=55${val('tr-pac-tel').replace(/\D/g,'')}&text=${encodeURIComponent(msg)}`,'_blank');}}}

function openFim(id){el('m-fim').style.display='flex';el('fim-id').value=id;}
function toggleRetorno(){el('fim-area-retorno').style.display=el('fim-retorno').checked?'block':'none';}
async function confFim(){await req('/agenda/status','POST',{id:val('fim-id'),status:'Finalizado'});if(el('fim-retorno').checked)showToast("Agende o retorno");closeM('m-fim');loadEspera();if(calendar)calendar.refetchEvents();loadDash();}

async function loadProf(){const l=await req('/profissionais');el('t-prof').innerHTML=(l||[]).map(p=>`<tr><td>${p.nome}</td><td>${p.crm}</td><td>${p.esp_nome}</td><td><button class="btn btn-s" onclick='editProf(${JSON.stringify(p)})'>‚úé</button></td></tr>`).join('');}
function modProf(){el('m-prof').style.display='flex';fill('pr-esp','/auxiliares/especialidades');['pr-id','pr-nome','pr-crm','pr-cpf','pr-nasc','pr-email','pr-tel','pr-rua','pr-banco','pr-pix','pr-comissao'].forEach(i=>el(i).value='');}
function editProf(p){modProf();el('pr-id').value=p.id;el('pr-nome').value=p.nome;el('pr-crm').value=p.crm;el('pr-email').value=p.email||'';}
async function saveProf(){if(await req('/profissionais/salvar','POST',{id:val('pr-id'),nome:val('pr-nome'),crm:val('pr-crm'),esp_id:val('pr-esp'),email:val('pr-email')})) { closeM('m-prof'); loadProf(); showToast('Salvo!'); } }

async function loadAux(t,b){curAux=t;if(b){document.querySelectorAll('#v-cadastros .tab').forEach(x=>x.classList.remove('active'));b.classList.add('active');}if(t=='convenios'){el('aux-simple-ctrl').style.display='none';el('aux-conv-ctrl').style.display='block';const l=await req('/convenios');el('t-aux').innerHTML=l.map(c=>`<tr><td>${c.nome}</td><td><button class="btn btn-s" onclick='editConv(${JSON.stringify(c)})'>‚úé</button> <button class="btn btn-d" onclick="delConv(${c.id})">X</button></td></tr>`).join('');}else{el('aux-simple-ctrl').style.display='flex';el('aux-conv-ctrl').style.display='none';const l=await req('/auxiliares/'+t);el('t-aux').innerHTML=l.map(i=>`<tr><td>${i.nome}</td><td><button class="btn btn-d" onclick="delAux(${i.id})">X</button></td></tr>`).join('');}}
function modConv(){el('m-conv').style.display='flex';['cv-id','cv-nome'].forEach(i=>el(i).value='');}
function editConv(c){modConv();el('cv-id').value=c.id;el('cv-nome').value=c.nome;}
async function saveConv(){if(await req('/convenios/salvar','POST',{id:val('cv-id'),nome:val('cv-nome')})) { closeM('m-conv'); loadAux('convenios'); }}
async function delConv(id){if(confirm('Apagar?')){await req(`/auxiliares/convenios/deletar/${id}`,'DELETE');loadAux('convenios');}}
async function salvAux(){if(await req(`/auxiliares/${curAux}/salvar`,'POST',{nome:val('aux-nome')})) { el('aux-nome').value=''; loadAux(curAux); }}
async function delAux(id){if(confirm('Apagar?')){await req(`/auxiliares/${curAux}/deletar/${id}`,'DELETE');loadAux(curAux);}}

async function loadPac(f){const l=await req('/pacientes?filtro='+f);el('t-pac').innerHTML=(l||[]).map(p=>`<tr><td>${p.nome}</td><td>${p.cpf}</td><td>${p.telefone_principal}</td><td><button class="btn btn-s" onclick='editPac(${JSON.stringify(p)})'>‚úé</button></td></tr>`).join('');}
function modPac(){el('m-pac').style.display='flex';fill('p-conv','/auxiliares/convenios');['p-id','p-nome','p-cpf'].forEach(i=>el(i).value='');}
function editPac(p){modPac();el('p-id').value=p.id;el('p-nome').value=p.nome;el('p-cpf').value=p.cpf;el('p-tel1').value=p.telefone_principal||'';el('p-conv').value=p.convenio_id||'';}
async function savePac(){if(await req('/pacientes/salvar','POST',{id:val('p-id'),nome:val('p-nome'),cpf:val('p-cpf'),tel:val('p-tel1'),conv:val('p-conv')})){closeM('m-pac');loadPac('');showToast('Salvo');}}

async function loadAgenda(){const i=val('ag-ini'),f=val('ag-fim'),p=val('ag-filter-prof');const l=await req(`/agenda?inicio=${i}&fim=${f}&prof_id=${p}`);el('t-ag').innerHTML=(l||[]).map(a=>`<tr><td>${a.data_hora_inicio.substring(8,10)}/${a.data_hora_inicio.substring(5,7)} <span style="color:var(--primary)">${a.data_hora_inicio.substring(11,16)}</span></td><td>${a.paciente}</td><td>${a.profissional}</td><td>${a.status}</td><td style="text-align:right"><button class="btn btn-s" onclick='editAg(${JSON.stringify(a)})'>‚úé</button> <button class="btn btn-d" onclick="delAg(${a.id})">X</button></td></tr>`).join('');}
function modAg(){el('m-ag').style.display='flex';currentAgId=null;fill('a-pac','/pacientes');fill('a-prof','/profissionais');fill('a-sala','/auxiliares/salas');el('a-data').value=val('ag-ini')||new Date().toISOString().split('T')[0];el('a-hora').value='';}
function editAg(a){modAg();currentAgId=a.id;setTimeout(()=>{el('a-pac').value=a.paciente_id;el('a-prof').value=a.profissional_id;},300);const p=a.data_hora_inicio.split(' ');el('a-data').value=p[0];el('a-hora').value=p[1].substring(0,5);}
async function delAg(id){if(confirm('Excluir?')){await req('/agenda/deletar/'+id,'DELETE');loadAgenda();loadDash();if(calendar)calendar.refetchEvents();}}
async function saveAg(){const pid=val('a-pac'),prid=val('a-prof'),dt=val('a-data'),hr=val('a-hora');if(!pid||!prid||!dt||!hr)return showToast('Preencha tudo','erro');
const resp = await req('/agenda/salvar','POST',{id:currentAgId,paciente_id:pid,profissional_id:prid,data:dt,hora:hr,sala_id:val('a-sala'),duracao:val('a-dur')});
if(resp && resp.msg === 'Ok'){closeM('m-ag');loadAgenda();loadDash();if(calendar)calendar.refetchEvents();showToast('Salvo');if(!currentAgId){const o=el('a-pac').options[el('a-pac').selectedIndex];if(o.dataset.tel && confirm("Enviar Whats?")){const m=`Ol√° *${o.text}*, agendado para *${dt.split('-').reverse().join('/')}* √†s *${hr}*!`;window.open(`https://api.whatsapp.com/send?phone=55${o.dataset.tel.replace(/\D/g,'')}&text=${encodeURIComponent(m)}`,'_blank');}}}
else if(resp && resp.erro) { alert("Erro: " + resp.erro); }}

function tabFin(t,b){curFin=t;if(b){document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));b.classList.add('active');}loadFin();}
async function loadFin(){const l=await req('/financeiro/'+curFin);let h='';if(curFin=='caixa')h=`<thead><tr><th>Data</th><th>Tipo</th><th>Desc</th><th>Valor</th></tr></thead><tbody>${l.map(i=>`<tr><td>${i.data_hora}</td><td>${i.tipo}</td><td>${i.descricao}</td><td>${i.valor}</td></tr>`).join('')}</tbody>`;else h=`<thead><tr><th>Venc</th><th>Nome</th><th>Valor</th><th>Status</th><th>A√ß√£o</th></tr></thead><tbody>${l.map(i=>`<tr><td>${i.data_vencimento}</td><td>${i.pessoa||i.descricao}</td><td>${i.valor_total}</td><td>${i.status}</td><td>${i.status!='Pago'&&i.status!='Recebido'?`<button class="btn btn-p" onclick="baixa(${i.id},${i.valor_total})">$</button>`:'‚úî'}</td></tr>`).join('')}</tbody>`;el('t-fin').innerHTML=h;}
function toggleFin(){const t=val('f-tipo');el('d-pac').style.display=t=='receber'?'block':'none';el('d-forn').style.display=t=='pagar'?'block':'none';}
function modFin(){el('m-fin').style.display='flex';fill('f-pac','/pacientes');toggleFin();}

// --- FINANCEIRO CORRIGIDO NO JS TAMB√âM ---
async function saveFin(){
    const resp = await req('/financeiro/salvar','POST',{
        tipo:val('f-tipo'),
        paciente_id:val('f-pac'),
        fornecedor:val('f-forn'),
        desc:val('f-desc'),
        valor:val('f-val'),
        venc:val('f-venc'),
        parc:val('f-parc'),
        cat:val('f-cat'), // AGORA TEM ASTERISCO * NO HTML PARA LEMBRAR
        cc:val('f-cc'),
        forma:val('f-forma')
    });
    
    if(resp && resp.msg === "Ok") { 
        closeM('m-fin'); 
        loadFin(); 
        loadDash(); 
        showToast("Lan√ßamento salvo!");
    } else if(resp && resp.erro) {
        alert("Erro ao salvar: " + resp.erro); // MOSTRA O ERRO REAL PARA VOC√ä
    }
}

function baixa(id,v){el('m-baixa').style.display='flex';el('b-id').value=id;el('b-val').value=v;}
async function confBaixa(){if(await req('/financeiro/baixar','POST',{id:val('b-id'),valor_pago:val('b-val'),tipo:curFin})){closeM('m-baixa');loadFin();loadDash();}}

async function gerarRel(){
    const t=val('rel-tipo'),i=val('rel-ini'),f=val('rel-fim');
    const d=await req('/relatorios/gerar','POST',{tipo:t,inicio:i,fim:f});
    el('rel-periodo-print').innerText = `Per√≠odo: ${i.split('-').reverse().join('/')} a ${f.split('-').reverse().join('/')}`;
    const s=el('rel-summary-area'); s.innerHTML='';
    let h='';
    
    if(t=='agendamentos'){
        let tot=d.length, conf=0, canc=0; d.forEach(x=>{if(x.status=='Confirmado')conf++;if(x.status=='Cancelado')canc++;});
        s.innerHTML=`<div class="rel-summary"><div class="rel-card"><h3>Total</h3><h1>${tot}</h1></div><div class="rel-card"><h3 style="color:#10B981">Confirmados</h3><h1>${conf}</h1></div><div class="rel-card"><h3 style="color:#EF4444">Cancelados</h3><h1>${canc}</h1></div></div>`;
        h=`<thead><tr><th>Data/Hora</th><th>Paciente</th><th>Profissional</th><th>Status</th></tr></thead><tbody>${d.map(x=>`<tr><td>${x.data_hora_inicio}</td><td>${x.paciente}</td><td>${x.profissional}</td><td>${x.status}</td></tr>`).join('')}</tbody>`;
    }
    else if(t=='financeiro'){
        let rec=0,des=0; d.forEach(x=>{if(x.tipo=='Receita')rec+=x.valor;else des+=x.valor;});
        s.innerHTML=`<div class="rel-summary"><div class="rel-card"><h3 style="color:#10B981">Receitas</h3><h1>R$ ${rec.toFixed(2)}</h1></div><div class="rel-card"><h3 style="color:#EF4444">Despesas</h3><h1>R$ ${des.toFixed(2)}</h1></div><div class="rel-card"><h3 style="color:#3B82F6">Saldo</h3><h1>R$ ${(rec-des).toFixed(2)}</h1></div></div>`;
        h=`<thead><tr><th>Data</th><th>Descri√ß√£o</th><th>Categoria</th><th>Tipo</th><th>Valor</th></tr></thead><tbody>${d.map(x=>`<tr><td>${x.data}</td><td>${x.descricao}</td><td>${x.categoria}</td><td>${x.tipo}</td><td>${x.valor}</td></tr>`).join('')}</tbody>`;
    }
    else if(t=='profissionais'){
         h=`<thead><tr><th>Profissional</th><th>Atendimentos Totais</th><th>Finalizados</th></tr></thead><tbody>${d.map(x=>`<tr><td>${x.profissional}</td><td>${x.atendimentos}</td><td>${x.finalizados}</td></tr>`).join('')}</tbody>`;
    }
    else if(t=='convenios'){
        h=`<thead><tr><th>Conv√™nio</th><th>Atendimentos</th></tr></thead><tbody>${d.map(x=>`<tr><td>${x.convenio}</td><td>${x.atendimentos}</td></tr>`).join('')}</tbody>`;
    }
    else if(t=='aniversariantes'){
        h=`<thead><tr><th>Dia</th><th>Nome</th><th>Telefone</th></tr></thead><tbody>${d.map(x=>`<tr><td>${x.dia}</td><td>${x.nome}</td><td>${x.telefone_principal}</td></tr>`).join('')}</tbody>`;
    }
    else {
        h=`<thead><tr>${Object.keys(d[0]||{}).map(k=>`<th>${k}</th>`).join('')}</tr></thead><tbody>${d.map(r=>`<tr>${Object.values(r).map(v=>`<td>${v}</td>`).join('')}</tr>`).join('')}</tbody>`;
    }
    el('rel-tab').innerHTML=h;
}

window.onload=checkAuth;
</script>
</body>
</html>